user  www-data;

worker_processes  auto;

load_module modules/ngx_http_waf_module.so; # v2 动态模块

error_log  logs/error.log  notice;
pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log  logs/access.log  combined;

    sendfile        on;
    keepalive_timeout  65;

    # WAF 基础配置（为 gotestwaf 精简）
    waf on;
    waf_shm_zone waf_block_zone 10m;

    # 规则目录与入口
    waf_jsons_dir WAF_RULES_JSON;
    waf_rules_json user/gotestwaf_user_rules.json;

    # 日志：开启 JSONL 便于分析
    waf_json_log logs/waf.jsonl;
    waf_json_log_level info;

    # 全局动作为 block；关闭动态封禁以避免干扰 gotestwaf 评分
    waf_default_action block;
    waf_dynamic_block_enable off;

    # 如需信任上游，可开启；默认 off
    # waf_trust_xff on;

    server {
        listen       8080 reuseport;
        server_name  localhost;

        location / {
            root   html;
            index  index.html index.htm;
            # 为避免 405 影响测试，保持与 v1 一致
            error_page 405 =200 $uri;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
